window.ZWaveRoutesPlotLib=function(){function p(b,d,k,e,f,g){g||(g=function(b){return b});return g((b-d)/(k-d))*(f-e)+e}function B(b){switch(b){case "Controller":return d.color.controller;case "FLiRS":return d.color.flirs;case "Sleeping":return d.color.sleeping;case "Routing":return d.color.routing;default:throw"Unknow type:"+b;}}function e(b){this.zna=b;this.data={nodes:this.zna.getNodes(),links:this.zna.getLinks()};this.selectedNode=null;this.initPlot();this.initNodes();this.nodesMoveAllowed=!1;
d3.select("#IMA_too_few_nodes").style("display",3>this.data.nodes.length?"block":"none");d3.select("#IMA_absent").style("display",this.zna.getStats().haveIMA?"none":"block");b=this.zna.getStats();d3.select("#gathering-period").html(Math.ceil((b.startStatistics-b.endStatistics)/60/60));d3.select("#packets-num").html(b.packetsCount);d3.select("#missing-stats").html(b.nodeNoStatistics.join(", "))}var d={color:{current:"coral",routedFor:"sandybrown",association:"red",problematic:"orange",controller:"lightgray",
flirs:"darkgreen",sleeping:"lightblue",routing:"black"},threshold:{explores:.1,retries:.2},status:{dead:"Node is dead",alive:"Node is alive"},routes:{othersOpacity:"0.3"},viewport:{sizeX:200,sizeY:100}};e.prototype.initPlot=function(){var b=d3.select("#svg");b.append("svg:defs").append("svg:marker").attr("id","triangle").attr("refX",8).attr("refY",2).attr("markerWidth",30).attr("markerHeight",30).attr("orient","auto").append("path").attr("d","M 0 0 4 2 0 4 1 2");b.append("rect").style("fill","none").style("pointer-events",
"all");this.chartLayer=b.append("g").classed("chartLayer",!0).attr("width",1).attr("height",1).attr("transform","translate(0,0)")};e.prototype.initNodes=function(){function b(){c.curNode?e(c.curNode):k();var a=d3.selectAll('input[name="ShowMode"]').filter(function(){return this.checked}).node().id;d3.selectAll(".ShowModeAnnotation").style("display","none");d3.selectAll(".ShowModeAnnotation."+a).style("display","table-row")}function e(a){c.curNode=a;if(c.manualRouteMode)l(),q(a.id);else if(d3.select("#ShowModeOutgoingRoutes").node().checked&&
x(c.zna.getMyNodeId(),a.id),d3.select("#ShowModeIncomingRoutes").node().checked&&x(a.id,c.zna.getMyNodeId()),d3.select("#ShowModeAllRoutes").node().checked&&r(),d3.select("#ShowModeNodeRoutes").node().checked){r();var b=a.id;d3.select(".links").selectAll('line[id1="'+b+'"]').attr("opacity","1");d3.select(".links").selectAll('line[id2="'+b+'"]').attr("opacity","1")}d3.select("#ShowRepeatingFor").node().checked&&C(a.id);d3.selectAll('circle[id="id'+a.id+'"]').attr("fill",d.color.current);d3.select("#ShowAssociations").node().checked&&
D(a.id);y(a);z(a)}function k(a){c.curNode=null;c.manualRouteMode?(l(),q()):(d3.select("#ShowModeOutgoingRoutes").node().checked&&l(),d3.select("#ShowModeIncomingRoutes").node().checked&&l(),d3.select("#ShowModeAllRoutes").node(),d3.select("#ShowModeNodeRoutes").node().checked&&r());E();y();z()}function v(a){c.manualRouteMode&&-1===c.manualRoute.indexOf(a.id)&&(c.manualRouteAppendHop(a),q())}function f(a){c.nodesMoveAllowed&&(d3.event.active||t.alphaTarget(1).restart(),a.fx=a.x,a.fy=a.y)}function g(a){c.nodesMoveAllowed&&
(a.fx=d3.event.x,a.fy=d3.event.y)}function w(a){c.nodesMoveAllowed&&(0>a.x&&(a.x=0),0>a.y&&(a.y=0),200<a.x&&(a.x=200),100<a.y&&(a.y=100),d3.event.active||t.alphaTarget(0),a.fx=null,a.fy=null)}function r(){d3.select(".links").selectAll("line").attr("stroke","black").attr("stroke-width",function(a){return 0==a.usage12?0:(a=a.rssi12||a.rssi21?(a.rssi12+a.rssi21)/((a.rssi12?1:0)+(a.rssi21?1:0)):0)?p(a,1,.4,.6,2.5):.3}).attr("stroke-dasharray",function(a){return"2,"+Math.round(10*a.fails12).toString()}).attr("opacity",
d3.select("#ShowModeAllRoutes").node().checked?"1":d3.select("#ShowAllRoutes").node().checked?d.routes.othersOpacity:"0")}function l(){d3.select(".links").selectAll("line").attr("opacity","0")}function q(a){var b=c.manualRoute[c.manualRoute.length-1];d3.select(".manualRoute").selectAll("line").attr("stroke","yellow").attr("stroke-width","1.7").attr("stroke-dasharray","2,0").attr("opacity",function(){var m=parseInt(this.attributes.id1.value,10),n=parseInt(this.attributes.id2.value,10),d;return m===
b&&n===a||n===b&&m===a||-1!==(d=c.manualRoute.indexOf(m))&&c.manualRoute[d+1]===n||-1!==(d=c.manualRoute.indexOf(n))&&c.manualRoute[d+1]===m?"1":"0"})}function x(a,b){var d=c.zna.getTrajectoryLinkMap(a,b);d3.select(".links").selectAll("line").attr("stroke","black").attr("stroke-width",function(a){a=c.zna.getStatUsage(d,a.source.id,a.target.id)||c.zna.getStatUsage(d,a.target.id,a.source.id);return p(a,0,1,.3,1.7,Math.sqrt)}).attr("stroke-dasharray",function(a){return"2,"+Math.round(10*(c.zna.getStatFailRate(d,
a.source.id,a.target.id)||c.zna.getStatFailRate(d,a.target.id,a.source.id))).toString()}).attr("opacity",function(a){return c.zna.getStatUsage(d,a.source.id,a.target.id)||c.zna.getStatUsage(d,a.target.id,a.source.id)?"1":"0"})}function E(){d3.selectAll("circle").attr("fill",function(a){return a.color}).attr("stroke",function(a){return a.color}).attr("stroke-width","0px")}function C(a){var b=c.zna.getNodesRoutedFor(a);d3.selectAll("circle").attr("fill",function(a){return-1!==b.indexOf(a.id)?d.color.routedFor:
a.color})}function D(a){d3.selectAll("circle").filter(function(b){return-1!==c.zna.getNodeAssociations(a).indexOf(b.id)}).attr("stroke",d.color.association).attr("stroke-width",.2)}function y(a){d3.select("#annotation-id").html(a?a.id:"");d3.select("#annotation-name").html(a?a.name:"");d3.select("#annotation-type").html(a?a.type:"");d3.select("#annotation-dead").html(a?a.dead?d.status.dead:d.status.alive:"");d3.select("#annotation-associations").html(a?c.zna.getNodeAssociations(a.id).join(", "):"")}
function z(a){if(a){if(a.id!==c.zna.getMyNodeId()){var b=c.zna.getMyNodeId(),d=c.zna.getTrajectoryStats(b,a.id),e=c.zna.getTrajectoryStats(a.id,b);d3.select("#annotation-delivery-rate").html(Math.round(100*d.deliveryRate)+"%");d3.select("#annotation-n-reroutes").html(isFinite(d.minOutHops)?Math.round(100*d.retries)+"%":"N/A");d3.select("#annotation-explore-frames").html(Math.round(100*e.explores)+"%");d3.select("#annotation-routes-to").html(d.routes.map(function(c){_r=c.slice();_r.unshift(b);_r.push(a.id);
return _r.join("&rarr;")}).filter(function(a,b,c){return c.indexOf(a)===b}).join("<br/>"));d3.select("#annotation-routes-from").html(e.routes.map(function(c){_r=c.slice();_r.unshift(a.id);_r.push(b);return _r.join("&rarr;")}).filter(function(a,b,c){return c.indexOf(a)===b}).join("<br/>"));d3.select("#annotation-in-packets").html(e.received);d3.select("#annotation-out-packets").html(d.sent);d3.select("#annotation-routes-for").html(c.zna.getNodesRoutedFor(a.id).join(", "))}}else d3.select("#annotation-delivery-rate").html(""),
d3.select("#annotation-n-reroutes").html(""),d3.select("#annotation-explore-frames").html(""),d3.select("#annotation-routes-to").html(""),d3.select("#annotation-routes-from").html(""),d3.select("#annotation-in-packets").html(""),d3.select("#annotation-out-packets").html(""),d3.select("#annotation-routes-for").html("")}var c=this,t=d3.forceSimulation(this.data.nodes).force("linkForce",d3.forceLink(this.data.links).id(function(a){return a.id}).distance(function(a){return 400}).strength(0));this.data.nodes.map(function(a){a.r=
p(a.usage,0,1,15,50,Math.sqrt)/8;a.color=B(a.type)});var h=this.data.nodes.filter(function(a){return null===a.x||null===a.y});if(1===h.length)h[0].x=d.viewport.sizeX/2,h[0].y=d.viewport.sizeY/2;else{var A=Math.min(d.viewport.sizeX,d.viewport.sizeY)/3,u=0;h.forEach(function(a){a.id===c.zna.getMyNodeId()?a.x=a.y=0:(a.x=A*Math.cos(2*Math.PI/(h.length-1)*u),a.y=A*Math.sin(2*Math.PI/(h.length-1)*u),u++);a.x+=d.viewport.sizeX/2;a.y+=d.viewport.sizeY/2})}var F=this.chartLayer.append("g").attr("class","links").selectAll("line").data(this.data.links).enter().append("line").attr("id1",
function(a){return a.source.id}).attr("id2",function(a){return a.target.id});this.chartLayer.append("g").attr("class","manualRoute");var G=this.chartLayer.append("g").attr("class","nodes").selectAll("circle").data(this.data.nodes).enter().append("circle").attr("id",function(a){return"id"+a.id}).attr("r",function(a){return a.r}).attr("fill",function(a){return a.color}).attr("mask",function(a){return a.dead?"url(#mask)":""}).call(d3.drag().on("start",f).on("drag",g).on("end",w)).on("mouseover",e).on("mouseout",
k).on("click",v),H=this.chartLayer.append("g").attr("class","labels").selectAll("text").data(this.data.nodes).enter().append("text").text(function(a){return a.id}).attr("font-size",2).attr("fill","white").attr("text-anchor","middle").attr("alignment-baseline","middle").attr("transform",function(a){return"translate(0,0)"}).call(d3.drag().on("start",f).on("drag",g).on("end",w)).on("mouseover",e).on("mouseout",k).on("click",v);d3.select("#ShowModeOutgoingRoutes").on("change",b);d3.select("#ShowModeIncomingRoutes").on("change",
b);d3.select("#ShowModeAllRoutes").on("change",b);d3.select("#ShowModeNodeRoutes").on("change",b);d3.selection.prototype.click=function(){this.each(function(){this.dispatchEvent(new MouseEvent("click"))})};d3.select('[ng-controller="RouteMapController"]').node().addEventListener("keydown",function(a){27===a.keyCode&&c.manualRouteMode&&c.manualRouteTerminate(!1);13===a.keyCode&&c.manualRouteMode&&c.manualRouteTerminate(!0);79===a.keyCode&&d3.select("#ShowModeOutgoingRoutes").click();73===a.keyCode&&
d3.select("#ShowModeIncomingRoutes").click();78===a.keyCode&&d3.select("#ShowModeNodeRoutes").click();65===a.keyCode&&d3.select("#ShowModeAllRoutes").click()},!0);t.on("tick",function(){F.attr("x1",function(a){return a.source.x}).attr("y1",function(a){return a.source.y}).attr("x2",function(a){return a.target.x}).attr("y2",function(a){return a.target.y});G.attr("cx",function(a){return a.x}).attr("cy",function(a){return a.y});H.attr("x",function(a){return a.x}).attr("y",function(a){return a.y})});b()};
e.prototype.manualRouteStart=function(b,d){this.setManualRoute=d;this.manualRouteMode=!0;this.manualRoute=[];this.manualRouteClear();b&&this.manualRouteAppendHop(b)};e.prototype.manualRouteClear=function(){d3.select(".manualRoute").selectAll("*").remove()};e.prototype.manualRouteAppendHop=function(b){var d=this;-1===this.manualRoute.indexOf(b.id)&&(this.manualRoute.push(b.id),d3.select(".manualRoute").selectAll("line").filter(function(){var b=parseInt(this.attributes.id1.value,10),e=parseInt(this.attributes.id2.value,
10),f;return(-1===(f=d.manualRoute.indexOf(b))||d.manualRoute[f+1]!==e)&&(-1===(f=d.manualRoute.indexOf(e))||d.manualRoute[f+1]!==b)}).remove(),this.data.nodes.forEach(function(e){e.id!==b.id&&-1===d.manualRoute.indexOf(e.id)&&d3.select(".manualRoute").append("line").attr("id1",b.id).attr("x1",b.x).attr("y1",b.y).attr("id2",e.id).attr("x2",e.x).attr("y2",e.y)}))};e.prototype.manualRouteTerminate=function(b){this.manualRouteMode=!1;this.manualRouteClear();b&&this.setManualRoute&&this.setManualRoute(this.manualRoute)};
e.prototype.allowMoveNodes=function(b){void 0!=b&&(this.nodesMoveAllowed=!this.nodesMoveAllowed);return this.nodesMoveAllowed};e.prototype.getNodesPositions=function(){return this.data.nodes.map(function(b){return{id:b.id,x:b.x,y:b.y}})};return e}();window.ZWaveRoutesPlotLib.prototype.getNodesPositions=window.ZWaveRoutesPlotLib.prototype.getNodesPositions;window.ZWaveRoutesPlotLib.prototype.allowMoveNodes=window.ZWaveRoutesPlotLib.prototype.allowMoveNodes;
window.ZWaveRoutesPlotLib.prototype.manualRouteStart=window.ZWaveRoutesPlotLib.prototype.manualRouteStart;