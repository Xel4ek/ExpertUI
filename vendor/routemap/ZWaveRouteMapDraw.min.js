window.ZWaveRoutesPlotLib=function(){function q(b,m,e,c,h,f){f||(f=function(b){return b});return f((b-m)/(e-m))*(h-c)+c}function A(b){switch(b){case "Controller":return c.color.controller;case "FLiRS":return c.color.flirs;case "Sleeping":return c.color.sleeping;case "Routing":return c.color.routing;default:throw"Unknow type:"+b;}}function k(b){d3.select(b).style("display","block");setTimeout(function(){d3.select(b).style("display","none")},5E3)}function l(b){d3.select(b).style("display","none")}function f(b){this.zna=
b;this.data={nodes:this.zna.getNodes(),links:this.zna.getLinks()};this.selectedNode=null;this.initPlot();this.initNodes();this.nodesMoveAllowed=!1;d3.select("#IMA_too_few_nodes").style("display",3>this.data.nodes.length?"block":"none");d3.select("#IMA_absent").style("display",this.zna.getStats().haveIMA?"none":"block");l("#manualRouteErrorBatteryToBattery");l("#manualRouteErrorBatteryRepeater");l("#manualRouteSet");l("#manualRouteInfo")}var c={color:{current:"coral",routedFor:"sandybrown",association:"red",
problematic:"orange",controller:"lightgray",flirs:"darkgreen",sleeping:"lightblue",routing:"black"},threshold:{explores:.1,retries:.2},status:{dead:"Node is dead",alive:"Node is alive"},routes:{othersOpacity:"0.3"},viewport:{sizeX:200,sizeY:100}};f.prototype.initPlot=function(){var b=d3.select("#svg");b.append("svg:defs").append("svg:marker").attr("id","triangle").attr("refX",8).attr("refY",2).attr("markerWidth",30).attr("markerHeight",30).attr("orient","auto").append("path").attr("d","M 0 0 4 2 0 4 1 2");
b.append("rect").style("fill","none").style("pointer-events","all");this.chartLayer=b.append("g").classed("chartLayer",!0).attr("width",1).attr("height",1).attr("transform","translate(0,0)")};f.prototype.initNodes=function(){function b(){d.curNode?m(d.curNode):e();var a=d3.selectAll('input[name="ShowMode"]').filter(function(){return this.checked}).node().id;d3.selectAll(".ShowModeAnnotation").style("display","none");d3.selectAll(".ShowModeAnnotation."+a).style("display","table-row")}function m(a){d.curNode=
a;if(d.manualRouteMode)p(),r(a.id);else if(d3.select("#ShowModeOutgoingRoutes").node().checked&&w(d.zna.getMyNodeId(),a.id,d3.select("#ShowPriorityRoute").node().checked),d3.select("#ShowModeIncomingRoutes").node().checked&&w(a.id,d.zna.getMyNodeId(),d3.select("#ShowPriorityRoute").node().checked),d3.select("#ShowModeAllRoutes").node().checked&&t(),d3.select("#ShowModeNodeRoutes").node().checked){t();var b=a.id;d3.select(".links").selectAll('line[id1="'+b+'"]').attr("opacity","1");d3.select(".links").selectAll('line[id2="'+
b+'"]').attr("opacity","1")}d3.select("#ShowRepeatingFor").node().checked&&B(a.id);d3.selectAll('circle[id="id'+a.id+'"]').attr("fill",c.color.current);d3.select("#ShowAssociations").node().checked&&C(a.id);x(a);y(a)}function e(a){d.curNode=null;d.manualRouteMode?(p(),r()):(d3.select("#ShowModeOutgoingRoutes").node().checked&&p(),d3.select("#ShowModeIncomingRoutes").node().checked&&p(),d3.select("#ShowModeAllRoutes").node(),d3.select("#ShowModeNodeRoutes").node().checked&&t());D();x();y()}function f(a){d.manualRouteMode&&
-1===d.manualRoute.indexOf(a.id)&&(d.manualRouteAppendHop(a),r())}function h(a){d.nodesMoveAllowed&&(d3.event.active||u.alphaTarget(1).restart(),a.fx=a.x,a.fy=a.y)}function k(a){d.nodesMoveAllowed&&(a.fx=d3.event.x,a.fy=d3.event.y)}function l(a){d.nodesMoveAllowed&&(0>a.x&&(a.x=0),0>a.y&&(a.y=0),200<a.x&&(a.x=200),100<a.y&&(a.y=100),d3.event.active||u.alphaTarget(0),a.fx=null,a.fy=null)}function t(){d3.select(".links").selectAll("line").attr("stroke","black").attr("stroke-width",function(a){return 0==
a.usage12?0:(a=a.rssi12||a.rssi21?(a.rssi12+a.rssi21)/((a.rssi12?1:0)+(a.rssi21?1:0)):0)?q(a,1,.4,.6,2.5):.3}).attr("stroke-dasharray",function(a){return"2,"+Math.round(10*a.fails12).toString()}).attr("opacity",d3.select("#ShowModeAllRoutes").node().checked?"1":d3.select("#ShowAllRoutes").node().checked?c.routes.othersOpacity:"0")}function p(){d3.select(".links").selectAll("line").attr("opacity","0")}function r(a){var b=d.manualRoute[d.manualRoute.length-1];5<d.manualRoute.length&&(a=0);d3.select(".manualRoute").selectAll("line").attr("stroke",
"yellow").attr("stroke-width","1.7").attr("stroke-dasharray","2,0").attr("opacity",function(){var e=parseInt(this.attributes.id1.value,10),c=parseInt(this.attributes.id2.value,10),g;return e===b&&c===a||c===b&&e===a||-1!==(g=d.manualRoute.indexOf(e))&&d.manualRoute[g+1]===c||-1!==(g=d.manualRoute.indexOf(c))&&d.manualRoute[g+1]===e?"1":"0"})}function w(a,b,e){var c=d.zna.getTrajectoryLinkMap(a,b);if(e){var g=d.zna.getNodePriorityRoutes(a)[b];g&&(g.unshift(a),g.push(b))}d3.select(".links").selectAll("line").attr("stroke",
function(){var a=parseInt(this.attributes.id1.value,10),b=parseInt(this.attributes.id2.value,10),d;return e&&g&&(-1!==(d=g.indexOf(a))&&g[d+1]===b||-1!==(d=g.indexOf(b))&&g[d+1]===a)?"yellow":"black"}).attr("stroke-width",function(a){a=d.zna.getStatUsage(c,a.source.id,a.target.id)||d.zna.getStatUsage(c,a.target.id,a.source.id);return q(a,0,1,.3,1.7,Math.sqrt)}).attr("stroke-dasharray",function(a){return"2,"+Math.round(10*(d.zna.getStatFailRate(c,a.source.id,a.target.id)||d.zna.getStatFailRate(c,a.target.id,
a.source.id))).toString()}).attr("opacity",function(a){return d.zna.getStatUsage(c,a.source.id,a.target.id)||d.zna.getStatUsage(c,a.target.id,a.source.id)?"1":"0"})}function D(){d3.selectAll("circle").attr("fill",function(a){return a.color}).attr("stroke",function(a){return a.color}).attr("stroke-width","0px")}function B(a){var b=d.zna.getNodesRoutedFor(a);d3.selectAll("circle").attr("fill",function(a){return-1!==b.indexOf(a.id)?c.color.routedFor:a.color})}function C(a){d3.selectAll("circle").filter(function(b){return-1!==
d.zna.getNodeAssociations(a).indexOf(b.id)}).attr("stroke",c.color.association).attr("stroke-width",.2)}function x(a){d3.select("#annotation-id").html(a?a.id:"");d3.select("#annotation-name").html(a?a.name:"");d3.select("#annotation-type").html(a?a.type:"");d3.select("#annotation-dead").html(a?a.dead?c.status.dead:c.status.alive:"");d3.select("#annotation-associations").html(a?d.zna.getNodeAssociations(a.id).join(", "):"")}function y(a){if(a){if(a.id!==d.zna.getMyNodeId()){var b=d.zna.getMyNodeId(),
c=d.zna.getTrajectoryStats(b,a.id),e=d.zna.getTrajectoryStats(a.id,b);d3.select("#annotation-delivery-rate").html(Math.round(100*c.deliveryRate)+"%");d3.select("#annotation-n-reroutes").html(isFinite(c.minOutHops)?Math.round(100*c.retries)+"%":"N/A");d3.select("#annotation-explore-frames").html(Math.round(100*e.explores)+"%");d3.select("#annotation-routes-to").html(c.routes.map(function(c){var e=c.slice();e.unshift(b);e.push(a.id);e=e.join("&rarr;");d.zna.isPriorityRoute(b,a.id,c)&&(e="<b>"+e+"</b>");
return e}).filter(function(a,b,d){return d.indexOf(a)===b}).join("<br/>"));d3.select("#annotation-routes-from").html(e.routes.map(function(c){var e=c.slice();e.unshift(a.id);e.push(b);e=e.join("&rarr;");d.zna.isPriorityRoute(a.id,b,c)&&(e="<b>"+e+"</b>");return e}).filter(function(a,b,e){return e.indexOf(a)===b}).join("<br/>"));d3.select("#annotation-in-packets").html(e.received);d3.select("#annotation-out-packets").html(c.sent);d3.select("#annotation-routes-for").html(d.zna.getNodesRoutedFor(a.id).join(", "))}}else d3.select("#annotation-delivery-rate").html(""),
d3.select("#annotation-n-reroutes").html(""),d3.select("#annotation-explore-frames").html(""),d3.select("#annotation-routes-to").html(""),d3.select("#annotation-routes-from").html(""),d3.select("#annotation-in-packets").html(""),d3.select("#annotation-out-packets").html(""),d3.select("#annotation-routes-for").html("")}var d=this,u=d3.forceSimulation(this.data.nodes).force("linkForce",d3.forceLink(this.data.links).id(function(a){return a.id}).distance(function(a){return 400}).strength(0));this.data.nodes.map(function(a){a.r=
q(a.usage,0,1,15,50,Math.sqrt)/8;a.color=A(a.type)});var n=this.data.nodes.filter(function(a){return null===a.x||null===a.y});if(1===n.length)n[0].x=c.viewport.sizeX/2,n[0].y=c.viewport.sizeY/2;else{var z=Math.min(c.viewport.sizeX,c.viewport.sizeY)/3,v=0;n.forEach(function(a){a.id===d.zna.getMyNodeId()?a.x=a.y=0:(a.x=z*Math.cos(2*Math.PI/(n.length-1)*v),a.y=z*Math.sin(2*Math.PI/(n.length-1)*v),v++);a.x+=c.viewport.sizeX/2;a.y+=c.viewport.sizeY/2})}var E=this.chartLayer.append("g").attr("class","links").selectAll("line").data(this.data.links).enter().append("line").attr("id1",
function(a){return a.source.id}).attr("id2",function(a){return a.target.id});this.chartLayer.append("g").attr("class","manualRoute");var F=this.chartLayer.append("g").attr("class","nodes").selectAll("circle").data(this.data.nodes).enter().append("circle").attr("id",function(a){return"id"+a.id}).attr("r",function(a){return a.r}).attr("fill",function(a){return a.color}).attr("mask",function(a){return a.dead?"url(#mask)":""}).call(d3.drag().on("start",h).on("drag",k).on("end",l)).on("mouseover",m).on("mouseout",
e).on("click",f),G=this.chartLayer.append("g").attr("class","labels").selectAll("text").data(this.data.nodes).enter().append("text").text(function(a){return a.id}).attr("font-size",2).attr("fill","white").attr("text-anchor","middle").attr("alignment-baseline","middle").attr("transform",function(a){return"translate(0,0)"}).call(d3.drag().on("start",h).on("drag",k).on("end",l)).on("mouseover",m).on("mouseout",e).on("click",f);d3.select("#ShowModeOutgoingRoutes").on("change",b);d3.select("#ShowModeIncomingRoutes").on("change",
b);d3.select("#ShowModeAllRoutes").on("change",b);d3.select("#ShowModeNodeRoutes").on("change",b);d3.selection.prototype.click=function(){this.each(function(){this.dispatchEvent(new MouseEvent("click"))})};u.on("tick",function(){E.attr("x1",function(a){return a.source.x}).attr("y1",function(a){return a.source.y}).attr("x2",function(a){return a.target.x}).attr("y2",function(a){return a.target.y});F.attr("cx",function(a){return a.x}).attr("cy",function(a){return a.y});G.attr("x",function(a){return a.x}).attr("y",
function(a){return a.y})});b()};f.prototype.manualRouteStart=function(b,c){this.setManualRoute=c;this.manualRouteMode=!0;this.manualRoute=[];this.manualRouteClear();b&&this.manualRouteAppendHop(b);k("#manualRouteInfo")};f.prototype.manualRouteClear=function(){d3.select(".manualRoute").selectAll("*").remove()};f.prototype.manualRouteAppendHop=function(b){var c=this;-1===this.manualRoute.indexOf(b.id)&&(this.manualRoute.push(b.id),d3.select(".manualRoute").selectAll("line").filter(function(){var b=
parseInt(this.attributes.id1.value,10),f=parseInt(this.attributes.id2.value,10),h;return(-1===(h=c.manualRoute.indexOf(b))||c.manualRoute[h+1]!==f)&&(-1===(h=c.manualRoute.indexOf(f))||c.manualRoute[h+1]!==b)}).remove(),this.data.nodes.forEach(function(e){e.id!==b.id&&-1===c.manualRoute.indexOf(e.id)&&d3.select(".manualRoute").append("line").attr("id1",b.id).attr("x1",b.x).attr("y1",b.y).attr("id2",e.id).attr("x2",e.x).attr("y2",e.y)}))};f.prototype.manualRouteTerminate=function(b){var c=this;this.manualRouteMode=
!1;this.manualRouteClear();if(b&&this.setManualRoute){b=this.manualRoute[0];var e=this.manualRoute[this.manualRoute.length-1],f=this.manualRoute.slice(1,-1);this.zna.isListening(b)||this.zna.isListening(e)?f.length&&f.map(function(b){return!c.zna.isListening(b)}).some(function(b){return b})?k("#manualRouteErrorBatteryRepeater"):(this.setManualRoute(this.manualRoute.slice()),this.zna.updatePriorityRoute(b,e,f),k("#manualRouteSet")):k("#manualRouteErrorBatteryToBattery")}};f.prototype.getPriorityRoutes=
function(){return this.zna.getPriorityRoutes()};f.prototype.updatePriorityRoute=function(b,c,e){return this.zna.updatePriorityRoute(b,c,e)};f.prototype.allowMoveNodes=function(b){void 0!=b&&(this.nodesMoveAllowed=!this.nodesMoveAllowed);return this.nodesMoveAllowed};f.prototype.getNodesPositions=function(){return this.data.nodes.map(function(b){return{id:b.id,x:b.x,y:b.y}})};f.prototype.getStats=function(){var b=this.zna.getStats();return{gatheringPeriod:Math.ceil((b.startStatistics-b.endStatistics)/
60/60),packetsNum:b.packetsCount,missingStats:b.nodeNoStatistics.join(", ")}};return f}();window.ZWaveRoutesPlotLib.prototype.getNodesPositions=window.ZWaveRoutesPlotLib.prototype.getNodesPositions;window.ZWaveRoutesPlotLib.prototype.allowMoveNodes=window.ZWaveRoutesPlotLib.prototype.allowMoveNodes;window.ZWaveRoutesPlotLib.prototype.manualRouteStart=window.ZWaveRoutesPlotLib.prototype.manualRouteStart;window.ZWaveRoutesPlotLib.prototype.getPriorityRoutes=window.ZWaveRoutesPlotLib.prototype.getPriorityRoutes;
window.ZWaveRoutesPlotLib.prototype.updatePriorityRoute=window.ZWaveRoutesPlotLib.prototype.updatePriorityRoute;window.ZWaveRoutesPlotLib.prototype.getStats=window.ZWaveRoutesPlotLib.prototype.getStats;