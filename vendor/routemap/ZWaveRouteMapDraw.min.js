window.ZWaveRoutesPlotLib=function(){function r(b,c,m,e,f,h){h||(h=function(b){return b});return h((b-c)/(m-c))*(f-e)+e}function B(b){switch(b){case "Controller":return c.color.controller;case "FLiRS":return c.color.flirs;case "Sleeping":return c.color.sleeping;case "Routing":return c.color.routing;default:throw"Unknow type:"+b;}}function k(b){d3.select(b).style("display","block");setTimeout(function(){d3.select(b).style("display","none")},5E3)}function g(b){d3.select(b).style("display","none")}function e(b){this.zna=
b;this.data={nodes:this.zna.getNodes(),links:this.zna.getLinks()};this.selectedNode=null;this.initPlot();this.initNodes();this.nodesMoveAllowed=!1;d3.select("#IMA_too_few_nodes").style("display",3>this.data.nodes.length?"block":"none");d3.select("#IMA_absent").style("display",this.zna.getStats().haveIMA?"none":"block");g("#manualRouteErrorBatteryToBattery");g("#manualRouteSet");g("#manualRouteInfo")}var c={color:{current:"coral",routedFor:"sandybrown",association:"red",problematic:"orange",controller:"lightgray",
flirs:"darkgreen",sleeping:"lightblue",routing:"black"},threshold:{explores:.1,retries:.2},status:{dead:"Node is dead",alive:"Node is alive"},routes:{othersOpacity:"0.3"},viewport:{sizeX:200,sizeY:100}};e.prototype.initPlot=function(){var b=d3.select("#svg");b.append("svg:defs").append("svg:marker").attr("id","triangle").attr("refX",8).attr("refY",2).attr("markerWidth",30).attr("markerHeight",30).attr("orient","auto").append("path").attr("d","M 0 0 4 2 0 4 1 2");b.append("rect").style("fill","none").style("pointer-events",
"all");this.chartLayer=b.append("g").classed("chartLayer",!0).attr("width",1).attr("height",1).attr("transform","translate(0,0)")};e.prototype.initNodes=function(){function b(){d.curNode?e(d.curNode):m();var a=d3.selectAll('input[name="ShowMode"]').filter(function(){return this.checked}).node().id;d3.selectAll(".ShowModeAnnotation").style("display","none");d3.selectAll(".ShowModeAnnotation."+a).style("display","table-row")}function e(a){d.curNode=a;if(d.manualRouteMode)n(),t(a.id);else if(d3.select("#ShowModeOutgoingRoutes").node().checked&&
x(d.zna.getMyNodeId(),a.id),d3.select("#ShowModeIncomingRoutes").node().checked&&x(a.id,d.zna.getMyNodeId()),d3.select("#ShowModeAllRoutes").node().checked&&g(),d3.select("#ShowModeNodeRoutes").node().checked){g();var b=a.id;d3.select(".links").selectAll('line[id1="'+b+'"]').attr("opacity","1");d3.select(".links").selectAll('line[id2="'+b+'"]').attr("opacity","1")}d3.select("#ShowRepeatingFor").node().checked&&C(a.id);d3.selectAll('circle[id="id'+a.id+'"]').attr("fill",c.color.current);d3.select("#ShowAssociations").node().checked&&
D(a.id);y(a);z(a)}function m(a){d.curNode=null;d.manualRouteMode?(n(),t()):(d3.select("#ShowModeOutgoingRoutes").node().checked&&n(),d3.select("#ShowModeIncomingRoutes").node().checked&&n(),d3.select("#ShowModeAllRoutes").node(),d3.select("#ShowModeNodeRoutes").node().checked&&g());E();y();z()}function w(a){d.manualRouteMode&&-1===d.manualRoute.indexOf(a.id)&&(d.manualRouteAppendHop(a),t())}function f(a){d.nodesMoveAllowed&&(d3.event.active||u.alphaTarget(1).restart(),a.fx=a.x,a.fy=a.y)}function h(a){d.nodesMoveAllowed&&
(a.fx=d3.event.x,a.fy=d3.event.y)}function k(a){d.nodesMoveAllowed&&(0>a.x&&(a.x=0),0>a.y&&(a.y=0),200<a.x&&(a.x=200),100<a.y&&(a.y=100),d3.event.active||u.alphaTarget(0),a.fx=null,a.fy=null)}function g(){d3.select(".links").selectAll("line").attr("stroke","black").attr("stroke-width",function(a){return 0==a.usage12?0:(a=a.rssi12||a.rssi21?(a.rssi12+a.rssi21)/((a.rssi12?1:0)+(a.rssi21?1:0)):0)?r(a,1,.4,.6,2.5):.3}).attr("stroke-dasharray",function(a){return"2,"+Math.round(10*a.fails12).toString()}).attr("opacity",
d3.select("#ShowModeAllRoutes").node().checked?"1":d3.select("#ShowAllRoutes").node().checked?c.routes.othersOpacity:"0")}function n(){d3.select(".links").selectAll("line").attr("opacity","0")}function t(a){var b=d.manualRoute[d.manualRoute.length-1];d3.select(".manualRoute").selectAll("line").attr("stroke","yellow").attr("stroke-width","1.7").attr("stroke-dasharray","2,0").attr("opacity",function(){var p=parseInt(this.attributes.id1.value,10),q=parseInt(this.attributes.id2.value,10),c;return p===
b&&q===a||q===b&&p===a||-1!==(c=d.manualRoute.indexOf(p))&&d.manualRoute[c+1]===q||-1!==(c=d.manualRoute.indexOf(q))&&d.manualRoute[c+1]===p?"1":"0"})}function x(a,b){var c=d.zna.getTrajectoryLinkMap(a,b);d3.select(".links").selectAll("line").attr("stroke","black").attr("stroke-width",function(a){a=d.zna.getStatUsage(c,a.source.id,a.target.id)||d.zna.getStatUsage(c,a.target.id,a.source.id);return r(a,0,1,.3,1.7,Math.sqrt)}).attr("stroke-dasharray",function(a){return"2,"+Math.round(10*(d.zna.getStatFailRate(c,
a.source.id,a.target.id)||d.zna.getStatFailRate(c,a.target.id,a.source.id))).toString()}).attr("opacity",function(a){return d.zna.getStatUsage(c,a.source.id,a.target.id)||d.zna.getStatUsage(c,a.target.id,a.source.id)?"1":"0"})}function E(){d3.selectAll("circle").attr("fill",function(a){return a.color}).attr("stroke",function(a){return a.color}).attr("stroke-width","0px")}function C(a){var b=d.zna.getNodesRoutedFor(a);d3.selectAll("circle").attr("fill",function(a){return-1!==b.indexOf(a.id)?c.color.routedFor:
a.color})}function D(a){d3.selectAll("circle").filter(function(b){return-1!==d.zna.getNodeAssociations(a).indexOf(b.id)}).attr("stroke",c.color.association).attr("stroke-width",.2)}function y(a){d3.select("#annotation-id").html(a?a.id:"");d3.select("#annotation-name").html(a?a.name:"");d3.select("#annotation-type").html(a?a.type:"");d3.select("#annotation-dead").html(a?a.dead?c.status.dead:c.status.alive:"");d3.select("#annotation-associations").html(a?d.zna.getNodeAssociations(a.id).join(", "):"")}
function z(a){if(a){if(a.id!==d.zna.getMyNodeId()){var b=d.zna.getMyNodeId(),c=d.zna.getTrajectoryStats(b,a.id),e=d.zna.getTrajectoryStats(a.id,b);d3.select("#annotation-delivery-rate").html(Math.round(100*c.deliveryRate)+"%");d3.select("#annotation-n-reroutes").html(isFinite(c.minOutHops)?Math.round(100*c.retries)+"%":"N/A");d3.select("#annotation-explore-frames").html(Math.round(100*e.explores)+"%");d3.select("#annotation-routes-to").html(c.routes.map(function(c){_r=c.slice();_r.unshift(b);_r.push(a.id);
return _r.join("&rarr;")}).filter(function(a,b,c){return c.indexOf(a)===b}).join("<br/>"));d3.select("#annotation-routes-from").html(e.routes.map(function(c){_r=c.slice();_r.unshift(a.id);_r.push(b);return _r.join("&rarr;")}).filter(function(a,b,c){return c.indexOf(a)===b}).join("<br/>"));d3.select("#annotation-in-packets").html(e.received);d3.select("#annotation-out-packets").html(c.sent);d3.select("#annotation-routes-for").html(d.zna.getNodesRoutedFor(a.id).join(", "))}}else d3.select("#annotation-delivery-rate").html(""),
d3.select("#annotation-n-reroutes").html(""),d3.select("#annotation-explore-frames").html(""),d3.select("#annotation-routes-to").html(""),d3.select("#annotation-routes-from").html(""),d3.select("#annotation-in-packets").html(""),d3.select("#annotation-out-packets").html(""),d3.select("#annotation-routes-for").html("")}var d=this,u=d3.forceSimulation(this.data.nodes).force("linkForce",d3.forceLink(this.data.links).id(function(a){return a.id}).distance(function(a){return 400}).strength(0));this.data.nodes.map(function(a){a.r=
r(a.usage,0,1,15,50,Math.sqrt)/8;a.color=B(a.type)});var l=this.data.nodes.filter(function(a){return null===a.x||null===a.y});if(1===l.length)l[0].x=c.viewport.sizeX/2,l[0].y=c.viewport.sizeY/2;else{var A=Math.min(c.viewport.sizeX,c.viewport.sizeY)/3,v=0;l.forEach(function(a){a.id===d.zna.getMyNodeId()?a.x=a.y=0:(a.x=A*Math.cos(2*Math.PI/(l.length-1)*v),a.y=A*Math.sin(2*Math.PI/(l.length-1)*v),v++);a.x+=c.viewport.sizeX/2;a.y+=c.viewport.sizeY/2})}var F=this.chartLayer.append("g").attr("class","links").selectAll("line").data(this.data.links).enter().append("line").attr("id1",
function(a){return a.source.id}).attr("id2",function(a){return a.target.id});this.chartLayer.append("g").attr("class","manualRoute");var G=this.chartLayer.append("g").attr("class","nodes").selectAll("circle").data(this.data.nodes).enter().append("circle").attr("id",function(a){return"id"+a.id}).attr("r",function(a){return a.r}).attr("fill",function(a){return a.color}).attr("mask",function(a){return a.dead?"url(#mask)":""}).call(d3.drag().on("start",f).on("drag",h).on("end",k)).on("mouseover",e).on("mouseout",
m).on("click",w),H=this.chartLayer.append("g").attr("class","labels").selectAll("text").data(this.data.nodes).enter().append("text").text(function(a){return a.id}).attr("font-size",2).attr("fill","white").attr("text-anchor","middle").attr("alignment-baseline","middle").attr("transform",function(a){return"translate(0,0)"}).call(d3.drag().on("start",f).on("drag",h).on("end",k)).on("mouseover",e).on("mouseout",m).on("click",w);d3.select("#ShowModeOutgoingRoutes").on("change",b);d3.select("#ShowModeIncomingRoutes").on("change",
b);d3.select("#ShowModeAllRoutes").on("change",b);d3.select("#ShowModeNodeRoutes").on("change",b);d3.selection.prototype.click=function(){this.each(function(){this.dispatchEvent(new MouseEvent("click"))})};u.on("tick",function(){F.attr("x1",function(a){return a.source.x}).attr("y1",function(a){return a.source.y}).attr("x2",function(a){return a.target.x}).attr("y2",function(a){return a.target.y});G.attr("cx",function(a){return a.x}).attr("cy",function(a){return a.y});H.attr("x",function(a){return a.x}).attr("y",
function(a){return a.y})});b()};e.prototype.manualRouteStart=function(b,c){this.setManualRoute=c;this.manualRouteMode=!0;this.manualRoute=[];this.manualRouteClear();b&&this.manualRouteAppendHop(b);k("#manualRouteInfo")};e.prototype.manualRouteClear=function(){d3.select(".manualRoute").selectAll("*").remove()};e.prototype.manualRouteAppendHop=function(b){var c=this;-1===this.manualRoute.indexOf(b.id)&&(this.manualRoute.push(b.id),d3.select(".manualRoute").selectAll("line").filter(function(){var b=
parseInt(this.attributes.id1.value,10),e=parseInt(this.attributes.id2.value,10),f;return(-1===(f=c.manualRoute.indexOf(b))||c.manualRoute[f+1]!==e)&&(-1===(f=c.manualRoute.indexOf(e))||c.manualRoute[f+1]!==b)}).remove(),this.data.nodes.forEach(function(e){e.id!==b.id&&-1===c.manualRoute.indexOf(e.id)&&d3.select(".manualRoute").append("line").attr("id1",b.id).attr("x1",b.x).attr("y1",b.y).attr("id2",e.id).attr("x2",e.x).attr("y2",e.y)}))};e.prototype.manualRouteTerminate=function(b){this.manualRouteMode=
!1;this.manualRouteClear();b&&this.setManualRoute&&(this.zna.isListening(this.manualRoute[0])||this.zna.isListening(this.manualRoute[this.manualRoute.length-1])?(this.setManualRoute(this.manualRoute),k("#manualRouteSet")):k("#manualRouteErrorBatteryToBattery"))};e.prototype.allowMoveNodes=function(b){void 0!=b&&(this.nodesMoveAllowed=!this.nodesMoveAllowed);return this.nodesMoveAllowed};e.prototype.getNodesPositions=function(){return this.data.nodes.map(function(b){return{id:b.id,x:b.x,y:b.y}})};
e.prototype.getStats=function(){var b=this.zna.getStats();return{gatheringPeriod:Math.ceil((b.startStatistics-b.endStatistics)/60/60),packetsNum:b.packetsCount,missingStats:b.nodeNoStatistics.join(", ")}};return e}();window.ZWaveRoutesPlotLib.prototype.getNodesPositions=window.ZWaveRoutesPlotLib.prototype.getNodesPositions;window.ZWaveRoutesPlotLib.prototype.allowMoveNodes=window.ZWaveRoutesPlotLib.prototype.allowMoveNodes;window.ZWaveRoutesPlotLib.prototype.manualRouteStart=window.ZWaveRoutesPlotLib.prototype.manualRouteStart;
window.ZWaveRoutesPlotLib.prototype.getStats=window.ZWaveRoutesPlotLib.prototype.getStats;